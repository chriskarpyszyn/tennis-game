<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>PONG</title>
</head>
<body>
    <canvas id="gameCanvas" width="800" height="600"></canvas>

<script src="js/SoundAndMusic.js"></script>
<script>

    var canvas;
    var canvasContext;

    var ballX = 75;
    var ballY = 75;

    const FPS_MULTIPLIER = 4;

    const BALL_SPEED_X = 26 / FPS_MULTIPLIER;
    const BALL_SPEED_Y = 16 / FPS_MULTIPLIER;

    const MIN_SPEED_Y = 5 / FPS_MULTIPLIER;
    const MAX_SPEED_Y = 14 / FPS_MULTIPLIER;

    var ySpeedMultiplier = 0.35 / FPS_MULTIPLIER;
    var ballSpeedX = BALL_SPEED_X;
    var ballSpeedY = BALL_SPEED_Y;
    var ballArc = 8;

    const PADDLE_WIDTH = 10;
    const PADDLE_HEIGHT = 87;

    const DEAD_ZONE = 43;
    
    var paddle1Height = PADDLE_HEIGHT;
    var paddle2Height = PADDLE_HEIGHT;

    var paddle1X = 0;
    var paddle1Y = 250;

    
    var paddle2Y = 250;

    var player1Score = 0;
    var player2Score = 0;

    const PADDLE_COMPUTER_MOVE_SPEED = 3;
    const MAX_SCORE = 11;

    var showingWinScreen = false;

    var soundBallBounce = new SoundOverlap("sound/blip");
    var soundMiss = new SoundOverlap("sound/miss");

    window.onload = function() {
        console.log("Hello World");

        const fps = 120;

        //save the canvas for dimensions and it's 2d context for drawing to it
        canvas = document.getElementById('gameCanvas');
        canvasContext = canvas.getContext('2d');

        canvas.addEventListener('mousemove', function(evt) {
            var mousePos = calculateMousePos(evt);
            paddle1Y = mousePos.y - (paddle1Height / 2);
            //paddle2Y = mousePos.y - (paddle2Height / 2);
        });

        canvas.addEventListener('mousedown', function () {
            if (showingWinScreen === true) {
                player1Score = 0;
                player2Score = 0;
                showingWinScreen = false;
            }
        });
        
        setInterval(function () {
            move();
            draw();
        }, 1000/fps);

    }

    function move() {

        if (showingWinScreen)
            return;

        moveComputerPaddle();

        //right paddle collision
        if (ballX >= canvas.width) {
            if (ballY > paddle2Y && ballY < paddle2Y + paddle2Height) {
                ballSpeedX *= -1;
                var deltaY = ballY - (paddle2Y + paddle2Height / 2);
                ballSpeedY = deltaY * ySpeedMultiplier;
                soundBallBounce.play();
            } else {
                player1Score++;
                ballReset();
            }
        }
        //left paddle collision
        if (ballX <= 0) {
            if (ballY > paddle1Y && ballY < paddle1Y + paddle1Height) {
                ballSpeedX *= -1;

                //collision test Y
                var deltaY = ballY - (paddle1Y + paddle1Height / 2);
                ballSpeedY = deltaY * ySpeedMultiplier;
                soundBallBounce.play();
            } else {
                player2Score++; 
                ballReset();
            }
        }

        if (player1Score >= MAX_SCORE || player2Score >= MAX_SCORE) {
            showingWinScreen = true;
        }

        if (ballY >= canvas.height) {
            ballSpeedY *= -1;
            soundBallBounce.play();
        }
        if (ballY <= 0) {
            ballSpeedY *= -1;
            soundBallBounce.play();
        }

        ballX += ballSpeedX;
        ballY += ballSpeedY;

    }

    function ballReset() {
        soundMiss.play();
        ballX = canvas.width / 2;
        ballY = canvas.height / 2;
        ballSpeedX *= -1;

        ballSpeedY = MIN_SPEED_Y + (Math.random() * (MAX_SPEED_Y - MIN_SPEED_Y));
        console.log(ballSpeedY);
        if (Math.random() > 0.5) {
            ballSpeedY *= -1.0;
            console.log(ballSpeedY);
        }

    }

    function colorRect(topLeftX, topRightY, boxWidth, boxHeight, fillColor) {
        canvasContext.fillStyle = fillColor;
        canvasContext.fillRect(topLeftX, topRightY, boxWidth, boxHeight);
    }

    function colorCircle(centerX, centerY, radius, fillColor) {
        canvasContext.fillStyle = fillColor;
        canvasContext.beginPath();
        canvasContext.arc(centerX, centerY, radius, 0, Math.PI * 2, true);
        canvasContext.fill();
    }

    function draw() {

        //test
        //ballX += 50;

        //clear game view by filling it with black
        colorRect(0, 0, canvas.width, canvas.height, '#000000');

        //write text      
        drawText(`Player1: ${player1Score}`, 100, 100, "#FFFFFF", "24px Comic Sans MS", 'left');
        drawText(`Player2: ${player2Score}`, canvas.width-100, 100, "#FFFFFF", "24px Comic Sans MS", 'right');

        ///TODO: Add Start Screen Game State
        if (!showingWinScreen) {
            colorRect(paddle1X, paddle1Y, PADDLE_WIDTH, paddle1Height, '#FFFFFF');
            colorRect(canvas.width - PADDLE_WIDTH, paddle2Y, PADDLE_WIDTH, paddle2Height, '#FFFFFF');
           
            //draw a white circle
            colorCircle(ballX, ballY, ballArc, '#FFFFFF');

            //draw net
           // var i = 0;
            for (var i=0; i<=canvas.height; i+=40) {
                colorRect(canvas.width/2-1, i, 2, 20, '#FFFFFF');
            }
            
        }
        else {
            var winText;
            if (player1Score == MAX_SCORE)
                winText = `Player 1 `;
            else
                winText = `Player 2 `;

            drawText(`${winText} Wins!`, (canvas.width / 2), canvas.height/2, "#FFFFFF", "24px Comic Sans MS", 'center');
            drawText("Click Mouse Button to continue", canvas.width/2, canvas.height-50, "#FFFFFF", "16px Comic Sans MS", 'center');

        }

        

    }

    function calculateMousePos(evt) {
        var rect = canvas.getBoundingClientRect(), root = document.documentElement;

        //account for margins, canvas position on page, scroll amount
        var mouseX = evt.clientX - rect.left - root.scrollLeft;
        var mouseY = evt.clientY - rect.top - root.scrollTop;

        return {
            x: mouseX,
            y: mouseY
        }
    }

    //function drawText(text, x, y, color, font) {
    //    //http://stackoverflow.com/questions/3697615/how-can-i-write-text-on-a-html5-canvas-element

    //    canvasContext.fillStyle = color;
    //    canvasContext.font = font;
    //    canvasContext.fillText(text, x, y);
    //}

    function drawText(text, x, y, color, font, textAlign) {

        canvasContext.fillStyle = color;
        canvasContext.font = font;
        canvasContext.textAlign = textAlign;
        canvasContext.fillText(text, x, y);
    }

    function moveComputerPaddle() {

        var paddle2Center = paddle2Y + paddle2Height / 2;
        

        if (ballY > paddle2Center+DEAD_ZONE)
            paddle2Y += PADDLE_COMPUTER_MOVE_SPEED;
        if (ballY < paddle2Center-DEAD_ZONE)
            paddle2Y -= PADDLE_COMPUTER_MOVE_SPEED;

    }



</script>
    
</body>
</html>